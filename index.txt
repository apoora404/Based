<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XP 효율 · 수수료 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{color-scheme:dark light}
    .num{font-variant-numeric:tabular-nums}
    input[type="range"]{accent-color:#6366f1}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-xl sm:text-2xl font-semibold">XP 효율 · 수수료 계산기</h1>
      <div class="text-xs sm:text-sm text-slate-400">v1.2 · 단일 파일 · 오프라인 동작 · 자동 저장(localStorage)</div>
    </div>
    <p class="mt-2 text-slate-400 text-sm">현물/선물, XP 부스트(0/25/50/60), Perps fee tiers 프리셋(Base/Diamond/Platinum, 0~6), 메이커/테이커 비율, 포인트(현재/이전) 입력을 조합해
      <span class="whitespace-nowrap">획득 포인트 · 총 거래량 · 총 수수료 · 1 XP당 거래량</span>을 계산합니다.</p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-28 space-y-5">
    <!-- Controls -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 space-y-4">
        <!-- Trading mode / XP boost -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <div class="grid sm:grid-cols-3 gap-3">
            <label class="block">
              <span class="block text-xs text-slate-400">거래 방식</span>
              <select id="marketKind" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="perps">선물(Perps)</option>
                <option value="spot">현물(Spot)</option>
              </select>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">XP 부스트</span>
              <select id="xpBoost" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="0">0%</option>
                <option value="25">25%</option>
                <option value="50">50%</option>
                <option value="60" selected>60%</option>
              </select>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">XP 효율 (XP / $)</span>
              <input id="xpPerDollar" type="number" step="0.00001" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              <span class="text-[11px] text-slate-500">프리셋 자동 계산, 필요시 직접 수정 가능</span>
            </label>
          </div>
        </div>

        <!-- Perps fee tiers (optional) + manual override  -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">수수료 선택 (Perps 표 프리셋 · 선택 시 자동 반영)</h3>
            <div class="text-xs text-slate-400">표를 선택하지 않으면 아래 수수료율 입력값을 사용</div>
          </div>
          <div class="grid sm:grid-cols-4 gap-3">
            <label class="block">
              <span class="block text-xs text-slate-400">클래스</span>
              <select id="tierClass" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="none" selected>선택 안 함</option>
                <option value="Base">Base</option>
                <option value="Diamond">Diamond</option>
                <option value="Platinum">Platinum</option>
              </select>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">Tier</span>
              <select id="tier" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
              </select>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">Taker 수수료율(%)</span>
              <input id="takerFee" type="number" step="0.0001" value="0.045" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">Maker 수수료율(%) <span class="text-slate-500">(리베이트는 음수)</span></span>
              <input id="makerFee" type="number" step="0.0001" value="0.015" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
          </div>
          <div class="grid sm:grid-cols-3 gap-3 mt-3">
            <label class="block col-span-2">
              <span class="block text-xs text-slate-400">Taker 비율</span>
              <input id="takerRatio" type="range" min="0" max="100" value="28" class="w-full" />
              <div class="text-xs text-slate-400"><span id="takerRatioLbl">28</span>% (Maker <span id="makerRatioLbl">72</span>%)</div>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">추천인 배분율 r(%)</span>
              <input id="refShare" type="number" step="0.1" value="60" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
          </div>
        </div>

        <!-- Inputs: volume or points -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <div class="grid sm:grid-cols-3 gap-3">
            <label class="block">
              <span class="block text-xs text-slate-400">입력 모드</span>
              <select id="mode" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="volume">거래량 입력</option>
                <option value="points">포인트(현재/이전)로 거래량 역산</option>
              </select>
            </label>
            <label class="block" id="volumeBox">
              <span class="block text-xs text-slate-400">총 거래량 ($)</span>
              <input id="volume" type="number" step="0.01" value="82881.86" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <div id="pointsBox" class="grid grid-cols-2 gap-3 hidden">
              <label class="block">
                <span class="block text-xs text-slate-400">이전 포인트</span>
                <input id="prevPts" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              </label>
              <label class="block">
                <span class="block text-xs text-slate-400">현재 포인트</span>
                <input id="currPts" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              </label>
            </div>
          </div>
          <div class="flex gap-2 mt-4">
            <button id="calc" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium">계산하기</button>
            <button id="save" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">입력값 저장</button>
            <button id="reset" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">초기화</button>
          </div>
        </div>
      </div>

      <!-- Output -->
      <aside class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold">결과</h3>
        <div id="out" class="space-y-2"></div>
        <div class="text-xs text-slate-500">※ 수수료는 (Taker%×Taker율 + Maker%×Maker율) 평균으로 계산합니다.
          거래소·계정 등급·리베이트에 따라 실제와 약간 차이 날 수 있습니다.</div>
      </aside>
    </section>

    <section class="text-xs text-slate-500">
      <p>저장 방식: 브라우저 <b>localStorage</b> 사용(쿠키 불필요). 장치/브라우저를 바꾸면 동기화되지 않습니다. 여러 장치에서 동기화하려면 서버 저장이 필요합니다.</p>
    </section>
  </main>

  <script>
    // === XP 효율 프리셋 ===
    // futures 0% = 0.03375 → 부스트 계수(1, 1.25, 1.5, 1.6)
    // spot    0% = 0.1266  → 동일 계수 적용
    const XP_BASE = { perps: 0.03375, spot: 0.1266 };
    const BOOST_FACTOR = {0:1, 25:1.25, 50:1.5, 60:1.6};

    // === Perps fee tiers ===
    const TIERS = {
      Base:  {0:{t:0.045,m:0.015},1:{t:0.040,m:0.012},2:{t:0.035,m:0.008},3:{t:0.030,m:0.004},4:{t:0.028,m:0.000},5:{t:0.026,m:0.000},6:{t:0.024,m:0.000}},
      Diamond:{0:{t:0.0270,m:0.0090},1:{t:0.0240,m:0.0072},2:{t:0.0210,m:0.0048},3:{t:0.0180,m:0.0024},4:{t:0.0168,m:0.0000},5:{t:0.0156,m:0.0000},6:{t:0.0144,m:0.0000}},
      Platinum:{0:{t:0.0315,m:0.0105},1:{t:0.0280,m:0.00849},2:{t:0.0245,m:0.00569},3:{t:0.0210,m:0.00289},4:{t:0.0196,m:0.00009},5:{t:0.0182,m:0.00009},6:{t:0.0168,m:0.00009}}
    };

    const $ = id => document.getElementById(id);

    function updateXpEfficiency(){
      const kind = $('marketKind').value;  // perps | spot
      const boost = $('xpBoost').value;    // 0/25/50/60
      const base = XP_BASE[kind] || 0.03375;
      const factor = BOOST_FACTOR[boost] || 1;
      $('xpPerDollar').value = (base * factor).toFixed(5);
    }

    function applyTierPreset(){
      const cls = $('tierClass').value; if(cls==='none') return;
      const tier = Number($('tier').value||0);
      const row = TIERS[cls] && TIERS[cls][tier];
      if(row){ $('takerFee').value = row.t; $('makerFee').value = row.m; }
    }

    function toggleMode(){
      const m = $('mode').value;
      $('volumeBox').classList.toggle('hidden', m!=="volume");
      $('pointsBox').classList.toggle('hidden', m!=="points");
    }

    function compute(){
      const takerRatio = Number($('takerRatio').value)/100;
      const makerRatio = 1 - takerRatio;
      const takerFee = Number($('takerFee').value)/100; // % → 1기준
      const makerFee = Number($('makerFee').value)/100;
      const avgFee = takerRatio*takerFee + makerRatio*makerFee;
      const xpPerDollar = Number($('xpPerDollar').value);

      let volume = 0, gainedXP = 0;
      if($('mode').value === 'volume'){
        volume = Number($('volume').value||0);
        gainedXP = volume * xpPerDollar;
      } else {
        const prev = Number($('prevPts').value||0);
        const curr = Number($('currPts').value||0);
        gainedXP = Math.max(0, curr - prev);
        volume = gainedXP / (xpPerDollar||1);
        $('volume').value = volume.toFixed(2);
      }

      const feeGross = volume * avgFee; // 총 수수료(달러)

      // 출력
      const d2 = n=> Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
      const d4 = n=> Number(n).toLocaleString(undefined,{minimumFractionDigits:4, maximumFractionDigits:4});

      $('out').innerHTML = `
        <div class="space-y-2 num">
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-slate-950/60 p-3 rounded-xl border border-slate-800"><div class="text-[11px] text-slate-400">획득 포인트</div><div class="text-xl">${d2(gainedXP)}</div></div>
            <div class="bg-slate-950/60 p-3 rounded-xl border border-slate-800"><div class="text-[11px] text-slate-400">총 거래량</div><div class="text-xl">${d2(volume)} $</div></div>
          </div>
          <div class="grid grid-cols-2 gap-2">
            <div class="bg-slate-950/60 p-3 rounded-xl border border-slate-800"><div class="text-[11px] text-slate-400">총 수수료(평균)</div><div class="text-xl">${d2(feeGross)} $</div><div class="text-[11px] text-slate-400">(Taker ${d4(takerFee*100)}% × ${d4(takerRatio*100)}% + Maker ${d4(makerFee*100)}% × ${d4(makerRatio*100)}%)</div></div>
            <div class="bg-slate-950/60 p-3 rounded-xl border border-slate-800"><div class="text-[11px] text-slate-400">1 XP 당 거래량</div><div class="text-xl">${gainedXP>0? d4(volume/gainedXP): '—'} $/XP</div></div>
          </div>
        </div>`;
    }

    function saveInputs(){
      const keys = ['marketKind','xpBoost','xpPerDollar','tierClass','tier','takerFee','makerFee','takerRatio','refShare','mode','volume','prevPts','currPts'];
      const obj = {}; keys.forEach(k=> obj[k] = $(k).value);
      localStorage.setItem('xp-fee-calc', JSON.stringify(obj));
      const btn = $('save'); btn.textContent = '저장됨'; setTimeout(()=>btn.textContent='입력값 저장', 1200);
    }

    function loadInputs(){
      const raw = localStorage.getItem('xp-fee-calc'); if(!raw){ updateXpEfficiency(); return; }
      try{
        const obj = JSON.parse(raw);
        Object.keys(obj).forEach(k=> { if($(k)) $(k).value = obj[k]; });
      }catch{}
      $('takerRatioLbl').textContent = $('takerRatio').value; $('makerRatioLbl').textContent = 100-Number($('takerRatio').value);
      updateXpEfficiency(); applyTierPreset(); toggleMode(); compute();
    }

    // UI events
    $('xpBoost').addEventListener('change', ()=>{ updateXpEfficiency(); });
    $('marketKind').addEventListener('change', ()=>{ updateXpEfficiency(); });
    $('tierClass').addEventListener('change', ()=>{ applyTierPreset(); });
    $('tier').addEventListener('change', ()=>{ applyTierPreset(); });
    $('takerRatio').addEventListener('input', ()=>{ $('takerRatioLbl').textContent = $('takerRatio').value; $('makerRatioLbl').textContent = 100-Number($('takerRatio').value); });
    $('mode').addEventListener('change', ()=>{ toggleMode(); });
    $('calc').addEventListener('click', compute);
    $('save').addEventListener('click', saveInputs);
    $('reset').addEventListener('click', ()=>{ localStorage.removeItem('xp-fee-calc'); location.reload(); });

    // init
    updateXpEfficiency();
    loadInputs();
  </script>
</body>
</html>
