<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XP 효율 · 수수료 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root{
      color-scheme: dark light;
      --bg:#0f1012; --panel:#17181c; --muted:#9aa4af;
      --accent:#ff6a3d; --ok:#2ad7a3; --danger:#ff6b6b;
      --ring: 0 0 0 3px rgba(255,106,61,.35);
    }
    body{background:var(--bg); color:#e6e8ea;}
    .card{background:var(--panel); border:1px solid #23262b;}
    .muted{color:var(--muted)}
    .btn{background:var(--accent); color:white}
    .btn:hover{filter:brightness(1.05)}
    .btn-ghost{background:#22252b; border:1px solid #2b2f36; color:#e6e8ea}
    input,select{background:#101216; border:1px solid #2a2f36; color:#e6e8ea; border-radius:12px; padding:.65rem .8rem; width:100%;}
    input:focus,select:focus{outline:none; box-shadow:var(--ring); border-color:#3a414b}
    .num{font-variant-numeric:tabular-nums}
    .badge{background:#121418; border:1px solid #2b2f36; padding:.2rem .5rem; border-radius:999px}
    .kv{display:flex; gap:.5rem; align-items:baseline}
    .kv .k{min-width:11rem; color:#aab2bd}
    .kv .v{font-weight:600}
  </style>
</head>
<body>
  <header class="max-w-5xl mx-auto px-4 py-7">
    <div class="rounded-3xl border border-[var(--accent)]/60 p-3 inline-block">
      <div class="rounded-2xl px-5 py-3 bg-[var(--panel)]">
        <h1 class="text-2xl font-semibold">XP 효율 · 수수료 계산기</h1>
      </div>
    </div>
    <p class="mt-3 muted text-sm">
      ▸ <b>이전/현재 포인트만</b> 입력하면 XP 차이로 <b>필요 거래량</b> 역산<br/>
      ▸ <b>이전/현재 거래량만</b> 입력하면 거래량 차이로 <b>획득 XP</b> 계산<br/>
      ▸ 총 수수료(누적) 이전/현재를 넣으면 차이로 <b>이번 구간 총 수수료</b> 반영(리베이트 60%는 결과에서만 표시)
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-28 space-y-6">
    <!-- 입력 -->
    <section class="card rounded-2xl p-4 space-y-4">
      <div class="grid sm:grid-cols-3 gap-3 items-end">
        <label class="block">
          <span class="block text-xs muted">거래 방식</span>
          <select id="mode">
            <option value="perps">선물 (Perps)</option>
            <option value="spot">현물 (Spot)</option>
          </select>
        </label>
        <label class="block">
          <span class="block text-xs muted">XP 부스트</span>
          <select id="boost">
            <option value="0">0%</option>
            <option value="25">25%</option>
            <option value="50">50%</option>
            <option value="60" selected>60%</option>
          </select>
        </label>
        <label class="block">
          <span class="block text-xs muted">14일 가중 거래량 Tier</span>
          <select id="tier"></select>
          <p class="text-[11px] muted mt-1" id="feeHint"></p>
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs muted">이전 거래량 (누적, $)</span>
          <input id="prevVol" type="number" step="0.01" placeholder="예: 200000" />
        </label>
        <label class="block">
          <span class="block text-xs muted">현재 거래량 (누적, $)</span>
          <input id="currVol" type="number" step="0.01" placeholder="예: 290000" />
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs muted">이전 포인트 (누적)</span>
          <input id="prevPts" type="number" step="0.01" placeholder="예: 12000" />
        </label>
        <label class="block">
          <span class="block text-xs muted">현재 포인트 (누적)</span>
          <input id="currPts" type="number" step="0.01" placeholder="예: 20000" />
        </label>
      </div>

      <!-- 고급 옵션: 총 수수료(누적) → 차이 -->
      <details class="rounded-xl bg-[#101216] border border-[#2a2f36] p-3">
        <summary class="cursor-pointer select-none muted text-sm">
          ▾ 고급 옵션(선택): 이전/현재 <b>총 수수료(누적)</b> 입력 → 사용 구간 총 수수료 자동 계산
        </summary>
        <div class="grid sm:grid-cols-2 gap-3 mt-3">
          <label class="block">
            <span class="block text-xs muted">이전 총 수수료 (누적, $)</span>
            <input id="prevFeeGross" type="number" step="0.01" />
          </label>
          <label class="block">
            <span class="block text-xs muted">현재 총 수수료 (누적, $)</span>
            <input id="currFeeGross" type="number" step="0.01" />
          </label>
        </div>
        <p class="text-[11px] muted mt-2">
          ※ 입력 시 두 값의 차이로 이번 구간 <b>총 수수료(리베이트 전)</b>이 자동 계산됩니다.
          리베이트(60%)는 결과에서만 반영합니다.
        </p>
      </details>

      <div class="flex flex-wrap gap-2">
        <button id="calc" class="btn px-4 py-2 rounded-xl font-semibold">계산하기</button>
        <button id="save" class="btn-ghost px-4 py-2 rounded-xl">입력값 저장</button>
        <button id="reset" class="btn-ghost px-4 py-2 rounded-xl">초기화</button>
      </div>
    </section>

    <!-- 결과 -->
    <section id="resultCard" class="card rounded-2xl p-4 space-y-3">
      <div class="flex items-center gap-2">
        <h3 class="font-semibold text-lg">결과</h3>
        <span class="badge text-xs" id="modeBadge">Perps · Tier 0</span>
        <span class="badge text-xs" id="feeBadge">Maker/Taker: -</span>
        <button id="copy" class="btn-ghost px-3 py-1.5 rounded-lg text-sm ml-auto">복사</button>
        <button id="saveImg" class="btn-ghost px-3 py-1.5 rounded-lg text-sm">PNG 저장</button>
      </div>
      <div id="out" class="space-y-2"></div>
      <p class="text-[11px] muted">
        평균 수수료율은 기본적으로 <b>Maker</b>만 가정합니다. 총 수수료(누적 차이)를 입력하면 평균 수수료율과
        <b>추정 Taker 비중</b>을 역산해 참고로 제공합니다. 리베이트 60%는 결과에서만 적용됩니다.
      </p>
    </section>
  </main>

  <script>
    // 수수료표 (소수)
    const FEES = {
      perps: { tiers: [
        { name: "Tier 0 (기본)", taker: 0.00045, maker: 0.00015 },
        { name: "Tier 1 (>5M)", taker: 0.00040, maker: 0.00012 },
        { name: "Tier 2 (>25M)", taker: 0.00035, maker: 0.00008 },
        { name: "Tier 3 (>100M)", taker: 0.00030, maker: 0.00004 },
        { name: "Tier 4 (>500M)", taker: 0.00028, maker: 0.00000 },
        { name: "Tier 5 (>2B)", taker: 0.00026, maker: 0.00000 },
        { name: "Tier 6 (>7B)", taker: 0.00024, maker: 0.00000 },
      ]},
      spot: { tiers: [
        { name: "Tier 0 (기본)", taker: 0.00070, maker: 0.00040 },
        { name: "Tier 1 (>5M)", taker: 0.00060, maker: 0.00030 },
        { name: "Tier 2 (>25M)", taker: 0.00050, maker: 0.00020 },
        { name: "Tier 3 (>100M)", taker: 0.00040, maker: 0.00010 },
        { name: "Tier 4 (>500M)", taker: 0.00035, maker: 0.00000 },
        { name: "Tier 5 (>2B)", taker: 0.00030, maker: 0.00000 },
        { name: "Tier 6 (>7B)", taker: 0.00025, maker: 0.00000 },
      ]},
    };

    // XP/$ 기본 효율 (부스트 0%)
    const XP_PER_DOLLAR_BASE = { perps: 0.03375, spot: 0.1266 };
    const xpPerDollar = (mode, boostPct)=> (XP_PER_DOLLAR_BASE[mode]||0) * (1 + (boostPct||0)/100);

    const $ = (id)=>document.getElementById(id);
    const d2 = (n)=> Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    const d4 = (n)=> Number(n||0).toLocaleString(undefined,{minimumFractionDigits:4,maximumFractionDigits:4});

    function populateTier(){
      const mode = $("mode").value, sel = $("tier"); sel.innerHTML = "";
      FEES[mode].tiers.forEach((t,i)=>{ const o=document.createElement("option"); o.value=i; o.textContent=t.name; sel.appendChild(o); });
      sel.value = 0; updateFeeHint();
    }
    function updateFeeHint(){
      const mode = $("mode").value, t=FEES[mode].tiers[Number($("tier").value)];
      $("feeHint").textContent = `Taker ${ (t.taker*100).toFixed(3) }% · Maker ${ (t.maker*100).toFixed(3) }%`;
      $("feeBadge").textContent = `Maker/Taker: ${(t.maker*100).toFixed(3)}% / ${(t.taker*100).toFixed(3)}%`;
      $("modeBadge").textContent = `${mode==='perps'?'Perps':'Spot'} · ${t.name}`;
    }
    $("mode").addEventListener("change", populateTier);
    $("tier").addEventListener("change", updateFeeHint);

    let _lastResult=null;

    function compute(){
      const mode = $("mode").value;
      const tierIdx = Number($("tier").value);
      const fee = FEES[mode].tiers[tierIdx];
      const makerFee = fee.maker, takerFee = fee.taker;
      const boost = Number($("boost").value||0);

      // 입력
      const prevVol = Number($("prevVol").value||0);
      const currVol = Number($("currVol").value||0);
      const prevPts = Number($("prevPts").value||0);
      const currPts = Number($("currPts").value||0);
      const prevFeeGross = Number($("prevFeeGross").value||0);
      const currFeeGross = Number($("currFeeGross").value||0);

      const haveVolPair = currVol>0 || prevVol>0;
      const havePtsPair = currPts>0 || prevPts>0;

      let usedVol = 0, usedPts = 0;
      const eff = xpPerDollar(mode, boost); // XP/$

      // 우선순위: (1) 둘 다 있으면 둘 다 사용 (2) 포인트만 있으면 거래량 역산 (3) 거래량만 있으면 XP 계산
      const deltaVol = (currVol && prevVol) ? Math.max(0, currVol - prevVol) : 0;
      const deltaPts = (currPts && prevPts) ? Math.max(0, currPts - prevPts) : 0;

      if (deltaVol>0 && deltaPts>0){
        usedVol = deltaVol; usedPts = deltaPts; // 그대로 사용
      } else if (deltaPts>0 && deltaVol===0){
        usedPts = deltaPts; usedVol = eff>0 ? usedPts/eff : 0; // XP -> Vol 역산
      } else if (deltaVol>0 && deltaPts===0){
        usedVol = deltaVol; usedPts = usedVol*eff;          // Vol -> XP 계산
      } else {
        // 입력 부족
        $("out").innerHTML = `<div class="text-sm muted">이전/현재 포인트 또는 거래량 중 하나의 쌍이라도 입력해 주세요.</div>`;
        _lastResult=null; return;
      }

      // 총 수수료(리베이트 전): 기본 Maker 가정, 누적차이 있으면 덮어쓰기
      let feeGross = usedVol * makerFee;
      const feeGrossInput = (currFeeGross>0 || prevFeeGross>0) ? Math.max(0, currFeeGross - prevFeeGross) : 0;
      if (feeGrossInput>0) feeGross = feeGrossInput;

      // 평균 수수료율 / 추정 Taker 비중
      const avgFeeRate = usedVol>0 ? (feeGross/usedVol) : 0;
      let takerShare = 0;
      if (usedVol>0 && takerFee!==makerFee){
        takerShare = Math.min(1, Math.max(0, (avgFeeRate - makerFee) / (takerFee - makerFee)));
      }

      // 리베이트 60% (결과만)
      const rebateRate = 0.60, rebateAmt=feeGross*rebateRate, feeNet=feeGross-rebateAmt;

      // 효율
      const xpEfficiency = usedVol>0 ? usedPts/usedVol : 0;
      const volPerXp = usedPts>0 ? usedVol/usedPts : 0;
      const costPerXp = usedPts>0 ? (feeNet/usedPts) : 0;

      // 참고: 기대 효율 대비 편차(둘 다 입력된 경우만)
      let effNote="";
      if (deltaVol>0 && deltaPts>0){
        const expectedEff = eff;
        const diffPct = expectedEff>0 ? ((xpEfficiency-expectedEff)/expectedEff*100) : 0;
        effNote = ` (기대 ${d4(expectedEff)} 대비 ${diffPct>=0?"+":""}${d2(diffPct)}%)`;
      }

      const rows=[];
      rows.push(`<div class="kv"><span class="k">사용 거래량</span><span class="v num">${d2(usedVol)} $</span></div>`);
      rows.push(`<div class="kv"><span class="k">획득 XP</span><span class="v num">${d2(usedPts)} XP</span></div>`);
      rows.push(`<div class="kv"><span class="k">XP 효율</span><span class="v num">${d4(xpEfficiency)} XP/$${effNote}</span></div>`);
      rows.push(`<div class="kv"><span class="k">1 XP당 거래량</span><span class="v num">${d4(volPerXp)} $/XP</span></div>`);
      rows.push(`<hr class="my-3 border-[#2b2f36]" />`);
      rows.push(`<div class="kv"><span class="k">총 수수료(리베이트 전)</span><span class="v num">${d2(feeGross)} $</span></div>`);
      rows.push(`<div class="kv"><span class="k">평균 수수료율</span><span class="v num">${d4(avgFeeRate*100)} %</span></div>`);
      rows.push(`<div class="kv"><span class="k">추정 Taker 비중</span><span class="v num">${d2(takerShare*100)} %</span></div>`);
      rows.push(`<div class="kv"><span class="k">셀프레퍼럴 수익(60%)</span><span class="v num text-[var(--ok)]">${d2(rebateAmt)} $</span></div>`);
      rows.push(`<div class="kv"><span class="k">실제 낸 수수료(리베이트 후)</span><span class="v num text-[var(--danger)]">${d2(feeNet)} $</span></div>`);
      rows.push(`<div class="kv"><span class="k">1 XP당 실질 비용(수수료만)</span><span class="v num">${d4(costPerXp)} $/XP</span></div>`);
      $("out").innerHTML = `<div class="space-y-1">${rows.join("")}</div>`;

      _lastResult = {
        mode: mode==='perps' ? 'Perps' : 'Spot',
        tier: FEES[mode].tiers[tierIdx].name,
        makerFee, takerFee, boost,
        usedVol, usedPts, xpEfficiency, volPerXp,
        feeGross, avgFeeRate, takerShare,
        rebateRate, rebateAmt, feeNet, costPerXp
      };

      updateFeeHint();
    }

    function copyResultToClipboard(){
      if (!_lastResult){ compute(); if(!_lastResult) return; }
      const r=_lastResult;
      const lines=[
        `=== XP 효율 · 수수료 요약 ===`,
        `모드: ${r.mode} · ${r.tier} · Boost ${r.boost}%`,
        `수수료(M/T): ${(r.makerFee*100).toFixed(3)}% / ${(r.takerFee*100).toFixed(3)}%`,
        ``,
        `사용 거래량: ${d2(r.usedVol)} $`,
        `획득 XP: ${d2(r.usedPts)} XP`,
        `XP 효율: ${d4(r.xpEfficiency)} XP/$`,
        `1 XP당 거래량: ${d4(r.volPerXp)} $/XP`,
        ``,
        `총 수수료(리베이트 전): ${d2(r.feeGross)} $`,
        `평균 수수료율: ${d4(r.avgFeeRate*100)} %`,
        `추정 Taker 비중: ${d2(r.takerShare*100)} %`,
        `셀프레퍼럴 수익(${Math.round(r.rebateRate*100)}%): ${d2(r.rebateAmt)} $`,
        `실제 낸 수수료(리베이트 후): ${d2(r.feeNet)} $`,
        `1 XP당 실질 비용(수수료만): ${d4(r.costPerXp)} $/XP`
      ].filter(Boolean).join('\n');

      const done=()=>{ const b=$("copy"); const t=b.textContent; b.textContent="복사됨 ✅"; setTimeout(()=>b.textContent=t,1200); };
      if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(lines).then(done).catch(()=>fallback()); }
      else fallback();
      function fallback(){
        const ta=document.createElement('textarea'); ta.value=lines; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); document.body.removeChild(ta); done();
      }
    }

    async function saveResultAsPng(){
      const node=document.getElementById('resultCard');
      const canvas=await html2canvas(node,{backgroundColor:null, scale:2, useCORS:true});
      const dataURL=canvas.toDataURL('image/png');
      const a=document.createElement('a'); a.href=dataURL; a.download='xp_calc_result.png';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      const b=$("saveImg"); const t=b.textContent; b.textContent="저장됨 ✅"; setTimeout(()=>b.textContent=t,1200);
    }

    // 저장/복원
    const KEYS=["mode","boost","tier","prevVol","currVol","prevPts","currPts","prevFeeGross","currFeeGross"];
    const saveInputs=()=>{ const obj={}; KEYS.forEach(k=>obj[k]=$(k).value); localStorage.setItem("based_xp_calc_v5",JSON.stringify(obj)); };
    function loadInputs(){
      const raw=localStorage.getItem("based_xp_calc_v5"); if(!raw) return;
      try{ const obj=JSON.parse(raw); if(obj.mode) $("mode").value=obj.mode; populateTier();
        KEYS.forEach(k=>{ if(obj[k]!==undefined && k!=="mode") $(k).value=obj[k]; }); updateFeeHint();
      }catch(e){}
    }
    function resetAll(){
      ["prevVol","currVol","prevPts","currPts","prevFeeGross","currFeeGross"].forEach(id=>$(id).value="");
      $("boost").value="60"; $("mode").value="perps"; populateTier(); $("out").innerHTML=""; _lastResult=null;
    }

    $("calc").addEventListener("click", compute);
    $("save").addEventListener("click", ()=>{ saveInputs(); compute(); });
    $("reset").addEventListener("click", ()=>{ resetAll(); saveInputs(); });
    $("copy").addEventListener("click", copyResultToClipboard);
    $("saveImg").addEventListener("click", saveResultAsPng);

    populateTier(); loadInputs(); updateFeeHint();
  </script>
</body>
</html>
