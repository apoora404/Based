<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Basedapp Checker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <style>
    :root { color-scheme: dark; }
    .num { font-variant-numeric: tabular-nums; }
    /* PNG 저장용: 모든 텍스트 강제 흰색 */
    .png-export * { color: #ffffff !important; }
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="max-w-4xl mx-auto px-4 py-6 text-center">
    <h1 class="text-2xl sm:text-3xl font-bold">📊 Basedapp Checker</h1>
    <p class="mt-2 text-slate-400 text-sm">이전/현재 거래량·포인트 입력 시 → 사용 구간 거래량/XP/수수료/리베이트 자동 계산</p>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-28 space-y-5">
    <!-- 입력 영역 -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-4">
      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs text-slate-400">이전 거래량 ($, 누적)</span>
          <input id="prevVol" type="number" placeholder="예: 200000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
        <label class="block">
          <span class="block text-xs text-slate-400">현재 거래량 ($, 누적)</span>
          <input id="currVol" type="number" placeholder="예: 290000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs text-slate-400">이전 포인트 (누적)</span>
          <input id="prevPts" type="number" placeholder="예: 12000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
        <label class="block">
          <span class="block text-xs text-slate-400">현재 포인트 (누적)</span>
          <input id="currPts" type="number" placeholder="예: 20000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs text-slate-400">이전 수수료 ($)</span>
          <input id="prevFee" type="number" placeholder="예: 50" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
        <label class="block">
          <span class="block text-xs text-slate-400">현재 수수료 ($)</span>
          <input id="currFee" type="number" placeholder="예: 120" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
      </div>

      <div class="flex gap-2 mt-4">
        <button id="calc" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium">계산하기</button>
        <button id="reset" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">초기화</button>
        <button id="copy" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">복사</button>
        <button id="save" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">PNG 저장</button>
      </div>
    </section>

    <!-- 결과 영역 -->
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
      <h3 class="font-semibold">결과</h3>
      <div id="out" class="space-y-2"></div>
    </section>
  </main>

  <!-- PNG Export 숨김 루트 -->
  <div id="png-export-root" style="position:fixed; left:-99999px; top:-99999px;"></div>

  <script>
    const $ = id => document.getElementById(id);

    function compute() {
      const prevVol = Number($("prevVol").value || 0);
      const currVol = Number($("currVol").value || 0);
      const prevPts = Number($("prevPts").value || 0);
      const currPts = Number($("currPts").value || 0);
      const prevFee = Number($("prevFee").value || 0);
      const currFee = Number($("currFee").value || 0);

      const usedVol = Math.max(0, currVol - prevVol);
      const usedPts = Math.max(0, currPts - prevPts);
      const usedFee = Math.max(0, currFee - prevFee);

      // XP 효율
      const xpEfficiency = usedVol > 0 ? (usedPts / usedVol) : 0;
      const volPerXp = usedPts > 0 ? (usedVol / usedPts) : 0;

      // 수수료 계산
      const totalFee = usedFee || usedVol * 0.00015; // 기본 maker 가정
      const avgFeeRate = usedVol > 0 ? totalFee / usedVol : 0;

      const rebate = totalFee * 0.6;
      const netFee = totalFee - rebate;

      const costPerXp = usedPts > 0 ? netFee / usedPts : 0;

      const d2 = n => Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const d4 = n => Number(n).toLocaleString(undefined, { minimumFractionDigits: 4, maximumFractionDigits: 4 });

      let rows = [];
      rows.push(`<div>사용 거래량: ${d2(usedVol)} $</div>`);
      rows.push(`<div>획득 XP: ${d2(usedPts)} XP</div>`);
      rows.push(`<div>XP 효율: ${d4(xpEfficiency)} XP/$</div>`);
      rows.push(`<div>1 XP당 거래량: ${d4(volPerXp)} $/XP</div>`);
      rows.push(`<div>총 수수료(리베이트 전): ${d2(totalFee)} $</div>`);
      rows.push(`<div>평균 수수료율: ${(avgFeeRate*100).toFixed(4)} %</div>`);
      rows.push(`<div>셀프레퍼럴 수익(60%): ${d2(rebate)} $</div>`);
      rows.push(`<div>실제 낸 수수료(리베이트 후): ${d2(netFee)} $</div>`);
      rows.push(`<div>1 XP당 실질 비용(수수료만): ${d4(costPerXp)} $/XP</div>`);

      $("out").innerHTML = `<div class='space-y-1'>${rows.join("")}</div>`;
    }

    $("calc").addEventListener("click", compute);
    $("reset").addEventListener("click", () => {
      ['prevVol','currVol','prevPts','currPts','prevFee','currFee'].forEach(id => $(id).value = '');
      $("out").innerHTML = '';
    });
    $("copy").addEventListener("click", () => {
      const text = $("out").innerText;
      navigator.clipboard.writeText(text);
      alert("결과가 클립보드에 복사되었습니다!");
    });
    $("save").addEventListener("click", async () => {
      const src = document.querySelector("#out");
      if (!src || !src.firstElementChild) { alert("저장할 결과가 없습니다."); return; }
      const clone = src.cloneNode(true);
      clone.classList.add("png-export");
      const root = document.getElementById("png-export-root");
      root.innerHTML = "";
      root.appendChild(clone);
      const canvas = await html2canvas(clone, {
        backgroundColor: "#0e0f12",
        scale: 3,
        useCORS: true
      });
      const a = document.createElement("a");
      a.download = "basedapp_checker_result.png";
      a.href = canvas.toDataURL("image/png");
      a.click();
      root.innerHTML = "";
    });
  </script>
</body>
</html>
