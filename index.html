<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XP 효율 · 수수료 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{color-scheme:dark light}
    .num{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="max-w-4xl mx-auto px-4 py-6">
    <h1 class="text-xl sm:text-2xl font-semibold">XP 효율 · 수수료 계산기</h1>
    <p class="mt-2 text-slate-400 text-sm">
      이전/현재 누적 거래량·포인트로 <b>사용 구간</b>을 계산하고,
      Tier별 수수료를 반영하여 총 수수료·셀퍼럴(60%)·XP 효율·XP당 단가·실질 비용을 구합니다.
      (실제 납부 수수료나 셀퍼럴 금액을 넣으면 <b>테이커 비중</b>을 역산)
    </p>
  </header>

  <main class="max-w-4xl mx-auto px-4 pb-28 space-y-5">
    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-4">
      <!-- 상단 입력: 누적 거래량/포인트 -->
      <div class="grid sm:grid-cols-3 gap-3">
        <label class="block">
          <span class="block text-xs text-slate-400">이전 거래량 (누적, $)</span>
          <input id="prevVol" type="number" step="0.01" placeholder="예: 200000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
        <label class="block">
          <span class="block text-xs text-slate-400">현재 거래량 (누적, $)</span>
          <input id="currVol" type="number" step="0.01" placeholder="예: 290000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>

        <label class="block">
          <span class="block text-xs text-slate-400">14일 가중 거래량 Tier</span>
          <select id="tier" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
            <option value="0">Tier 0 (기본)</option>
            <option value="1">Tier 1 (> $5M)</option>
            <option value="2">Tier 2 (> $25M)</option>
            <option value="3">Tier 3 (> $100M)</option>
            <option value="4">Tier 4 (> $500M)</option>
            <option value="5">Tier 5 (> $2B)</option>
            <option value="6">Tier 6 (> $7B)</option>
          </select>
          <span class="text-[11px] text-slate-500">선택에 따라 Maker/Taker 수수료 자동 반영</span>
        </label>
      </div>

      <div class="grid sm:grid-cols-2 gap-3">
        <label class="block">
          <span class="block text-xs text-slate-400">이전 포인트 (누적)</span>
          <input id="prevPts" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
        <label class="block">
          <span class="block text-xs text-slate-400">현재 포인트 (누적)</span>
          <input id="currPts" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
        </label>
      </div>

      <!-- 선택 입력: 실측 수수료 또는 셀프레퍼럴 금액으로 Taker 비중 역산 -->
      <details class="text-sm text-slate-300">
        <summary class="cursor-pointer select-none">고급 옵션(선택): 실측 수수료 / 셀프레퍼럴로 Taker 비중 역산</summary>
        <div class="grid sm:grid-cols-3 gap-3 mt-2">
          <label class="block">
            <span class="block text-xs text-slate-400">실제 납부 수수료($)</span>
            <input id="feePaid" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
          </label>
          <label class="block">
            <span class="block text-xs text-slate-400">셀프레퍼럴 수익($)</span>
            <input id="refRev" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
          </label>
          <label class="block">
            <span class="block text-xs text-slate-400">셀프레퍼럴 배분율 r(%)</span>
            <input id="refShare" type="number" step="0.1" value="60" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
          </label>
        </div>
        <p class="mt-2 text-[11px] text-slate-500">
          ※ 실측 값이 없으면 기본은 Maker만(지정가) 가정. 값을 넣으면 평균 수수료율→Taker 비중을 역산합니다.
        </p>
      </details>

      <div class="flex gap-2 mt-4">
        <button id="calc" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium">계산하기</button>
        <button id="reset" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">초기화</button>
      </div>
    </section>

    <section class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
      <h3 class="font-semibold">결과</h3>
      <div id="out" class="space-y-2"></div>
      <div class="text-xs text-slate-500">평균 수수료율은 기본적으로 Maker만 가정합니다. 실측 수수료/셀프레퍼럴을 입력하면 Taker 비중을 역산해 평균 수수료율을 갱신합니다.</div>
    </section>
  </main>

  <script>
    // Tier별 수수료율 (절대값; 1 기준)
    const TIERS = {
      0:{ m:0.00015, t:0.00045 }, // 0.015% / 0.045%
      1:{ m:0.00012, t:0.00040 },
      2:{ m:0.00008, t:0.00035 },
      3:{ m:0.00004, t:0.00030 },
      4:{ m:0.00000, t:0.00028 },
      5:{ m:0.00000, t:0.00026 },
      6:{ m:0.00000, t:0.00024 }
    };

    const $ = id=>document.getElementById(id);

    function compute(){
      // 입력값
      const prevVol = +($("prevVol").value||0);
      const currVol = +($("currVol").value||0);
      const prevPts = +($("prevPts").value||0);
      const currPts = +($("currPts").value||0);
      const tier    = +($("tier").value||0);

      const feePaidIn = +($("feePaid").value||0);
      const refRevIn  = +($("refRev").value||0);
      const refShare  = (+($("refShare").value||60))/100;

      // 사용 구간(이번 기간) 계산
      const usedVol = (currVol && prevVol) ? Math.max(0, currVol - prevVol) : 0;
      const usedPts = (currPts && prevPts) ? Math.max(0, currPts - prevPts) : 0;

      // Tier에 따른 Maker/Taker 수수료율
      const makerFee = (TIERS[tier]?.m) ?? 0.00015;
      const takerFee = (TIERS[tier]?.t) ?? 0.00045;

      // 기본 평균 수수료율(실측 없을 때는 Maker만 가정)
      let avgFeeRate = makerFee;

      // 실측 수수료 또는 셀프레퍼럴 금액으로 평균 수수료율 보정
      let feePaid = feePaidIn;
      if(!feePaid && refRevIn && refShare>0) {
        feePaid = refRevIn / refShare; // 총 수수료 = 셀프레퍼럴 / r
      }
      let takerRatio = null;
      if(feePaid && usedVol>0){
        avgFeeRate = feePaid / usedVol;                // 실측 평균 수수료율
        const denom = (takerFee - makerFee);
        takerRatio = denom>0 ? Math.min(1, Math.max(0, (avgFeeRate - makerFee)/denom)) : 0;
      }

      // 수수료 및 파생값
      const totalFee = usedVol * avgFeeRate;           // 이번 구간 총 수수료($)
      const selfRef  = totalFee * refShare;            // 셀프레퍼럴(기본 60%)
      const netFee   = totalFee - selfRef;             // 실납부 수수료
      const feeMakerOnly = usedVol * makerFee;         // 너비 참고용
      const feeTakerOnly = usedVol * takerFee;

      // XP 효율/단가 (사용 구간만)
      const xpEfficiency = usedVol>0 ? (usedPts/usedVol) : 0;  // XP/$
      const volPerXP     = usedPts>0 ? (usedVol/usedPts) : 0;  // $/XP
      const costPerXP    = usedPts>0 ? (netFee/usedPts) : 0;   // $/XP

      const d2=n=>Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
      const d4=n=>Number(n).toLocaleString(undefined,{minimumFractionDigits:4,maximumFractionDigits:4});

      // 출력
      let html = `<div class="bg-emerald-900/20 border border-emerald-800 rounded-xl p-3">
        <div class="font-semibold">✅ 최종 정리</div>
        <ul class="list-disc ml-5 mt-2 num space-y-1">
          <li>사용 거래량: ${d2(usedVol)} $</li>
          <li>획득 XP: ${d2(usedPts)} XP</li>
          <li>XP 효율: ${d4(xpEfficiency)} XP/$</li>
          <li>1 XP당 거래량: ${volPerXP? d4(volPerXP): '—'} $/XP</li>
          <li>총 수수료(추정): ${d2(totalFee)} $</li>
          <li>셀프레퍼럴(${d2(refShare*100)}%): ${d2(selfRef)} $</li>
          <li>실제 낸 수수료(= 총 수수료 − 셀프레퍼럴): ${d2(netFee)} $</li>
          <li>1 XP당 <b>실질 비용</b>(수수료만): ${costPerXP? d4(costPerXP): '—'} $/XP</li>
        </ul>
      </div>`;

      html += `<div class="bg-slate-950/60 rounded-xl p-3 border border-slate-800 num">
        <div class="text-[11px] text-slate-400">수수료율 · 체결 비중</div>
        <div>Tier ${tier} 사용 수수료율: Maker ${(makerFee*100).toFixed(3)}% · Taker ${(takerFee*100).toFixed(3)}%</div>
        <div class="text-[11px] text-slate-400 mt-1">기본은 Maker만 가정. 실측 수수료/셀프레퍼럴 입력 시 평균 수수료율을 보정하고 Taker 비중을 역산합니다.</div>`;
      if(takerRatio!==null){
        html += `<div class="mt-1">추정 Taker 비중: ${d4(takerRatio*100)} %</div>`;
      } else {
        html += `<div class="mt-1 text-xs text-slate-500">Taker 비중 추정을 원하면 '실제 납부 수수료' 또는 '셀프레퍼럴 수익'을 입력하세요.</div>`;
      }
      html += `</div>`;

      $("out").innerHTML = html;
    }

    $("calc").addEventListener("click", compute);
    ["prevVol","currVol","prevPts","currPts","feePaid","refRev","refShare","tier"].forEach(id=>{
      const el=$(id); if(!el) return; el.addEventListener("keydown",e=>{ if(e.key==="Enter") compute(); });
      if(id==="tier") el.addEventListener("change", compute);
    });
    $("reset").addEventListener("click", ()=>{
      ["prevVol","currVol","prevPts","currPts","feePaid","refRev"].forEach(id=>$(id).value="");
      $("refShare").value = 60;
      $("tier").value = 0;
      $("out").innerHTML="";
    });
  </script>
</body>
</html>
