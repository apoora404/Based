<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XP 효율 · 수수료 계산기</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{color-scheme:dark light}
    .num{font-variant-numeric:tabular-nums}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">
  <header class="max-w-5xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between gap-3">
      <h1 class="text-xl sm:text-2xl font-semibold">XP 효율 · 수수료 계산기</h1>
      <div class="text-xs sm:text-sm text-slate-400">v1.4 · 오프라인 · 자동저장(localStorage)</div>
    </div>
    <p class="mt-2 text-slate-400 text-sm">
      Base 수수료(메이커 0.015%, 테이커 0.045%) 기준. 거래량/포인트로 계산하고,
      선택 입력(실제 수수료·셀프레퍼럴) 시 테이커 비중을 역산해 평균 수수료율을 구합니다.
    </p>
  </header>

  <main class="max-w-5xl mx-auto px-4 pb-24 space-y-5">
    <!-- 프리셋 -->
    <section class="grid md:grid-cols-3 gap-4">
      <div class="md:col-span-2 space-y-4">
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <div class="grid sm:grid-cols-3 gap-3">
            <label class="block">
              <span class="block text-xs text-slate-400">거래 방식</span>
              <select id="marketKind" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="perps" selected>선물(Perps)</option>
                <option value="spot">현물(Spot)</option>
              </select>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">XP 부스트</span>
              <select id="xpBoost" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2">
                <option value="0">0%</option>
                <option value="25">25%</option>
                <option value="50">50%</option>
                <option value="60" selected>60%</option>
              </select>
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">XP 효율 (XP/$)</span>
              <input id="xpPerDollar" type="number" step="0.00001" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              <span class="text-[11px] text-slate-500">프리셋 자동 계산, 필요 시 직접 수정 가능</span>
            </label>
          </div>
        </div>

        <!-- Base 수수료 -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <h3 class="font-semibold mb-2">수수료 (Base 고정)</h3>
          <div class="grid sm:grid-cols-4 gap-3">
            <label class="block">
              <span class="block text-xs text-slate-400">Maker 수수료율(%)</span>
              <input id="makerFee" type="number" step="0.0001" value="0.015" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">Taker 수수료율(%)</span>
              <input id="takerFee" type="number" step="0.0001" value="0.045" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">셀프레퍼럴 배분율 r(%)</span>
              <input id="refShare" type="number" step="0.1" value="60" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
          </div>
        </div>

        <!-- 입력 -->
        <div class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4">
          <div class="grid sm:grid-cols-3 gap-3">
            <label class="block">
              <span class="block text-xs text-slate-400">총 거래량 ($)</span>
              <input id="volume" type="number" step="0.01" placeholder="예: 82881.86" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">이전 포인트</span>
              <input id="prevPts" type="number" step="0.01" placeholder="선택" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">현재 포인트</span>
              <input id="currPts" type="number" step="0.01" placeholder="선택" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
          </div>

          <div class="grid sm:grid-cols-3 gap-3 mt-3">
            <label class="block">
              <span class="block text-xs text-slate-400">이전 거래량 ($)</span>
              <input id="prevVol" type="number" step="0.01" placeholder="선택" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
            <label class="block">
              <span class="block text-xs text-slate-400">현재 거래량 ($)</span>
              <input id="currVol" type="number" step="0.01" placeholder="선택" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
            </label>
          </div>

          <details class="mt-3 text-sm text-slate-300">
            <summary class="cursor-pointer select-none">고급 옵션(선택): 실제 납부 수수료 / 셀프레퍼럴 금액으로 Taker 비중 역산</summary>
            <div class="grid sm:grid-cols-4 gap-3 mt-2">
              <label class="block">
                <span class="block text-xs text-slate-400">실제 납부 수수료($)</span>
                <input id="feePaid" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              </label>
              <label class="block">
                <span class="block text-xs text-slate-400">셀프레퍼럴 수익($)</span>
                <input id="refRev" type="number" step="0.01" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              </label>
              <label class="block">
                <span class="block text-xs text-slate-400">평균 1회 체결 금액($, 선택)</span>
                <input id="avgFill" type="number" step="0.01" placeholder="예: 3,000" class="mt-1 w-full rounded-xl bg-slate-900 border border-slate-700 p-2" />
              </label>
            </div>
          </details>

          <div class="flex gap-2 mt-4">
            <button id="calc" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium">계산하기</button>
            <button id="save" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">입력값 저장</button>
            <button id="reset" class="px-4 py-2 rounded-xl bg-slate-800 hover:bg-slate-700 border border-slate-700">초기화</button>
          </div>
        </div>
      </div>

      <!-- 결과 -->
      <aside class="bg-slate-900/60 border border-slate-800 rounded-2xl p-4 space-y-3">
        <h3 class="font-semibold">결과</h3>
        <div id="out" class="space-y-2"></div>
        <div class="mt-3">
          <button id="calcFloating" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-medium">계산하기</button>
        </div>
        <div class="text-xs text-slate-500 mt-3">
          평균 수수료율은 기본적으로 Maker만(0.015%) 가정합니다.
          실제 납부 수수료나 셀프레퍼럴 금액을 입력하면 Taker 비중을 역산해 평균 수수료율을 계산합니다.
        </div>
      </aside>
    </section>

    <section class="text-xs text-slate-500">
      저장 방식: <b>localStorage</b> 사용(쿠키 불필요). 브라우저/기기 변경 시 동기화되지 않습니다.
    </section>
  </main>

  <script>
    // 프리셋: XP 효율
    const XP_BASE = { perps: 0.03375, spot: 0.1266 }; // 0% 기준
    const BOOST = {0:1, 25:1.25, 50:1.5, 60:1.6};
    const $ = id => document.getElementById(id);

    function setXp(){
      const base = XP_BASE[$('marketKind').value] ?? 0.03375;
      const factor = BOOST[$('xpBoost').value] ?? 1;
      $('xpPerDollar').value = (base*factor).toFixed(5);
    }

    function compute(){
      const xpPerDollar = +($('xpPerDollar').value||0);
      const makerFee = +($('makerFee').value||0)/100;
      const takerFee = +($('takerFee').value||0)/100;

      const volManual = +($('volume').value||0);
      const prevPts   = +($('prevPts').value||0);
      const currPts   = +($('currPts').value||0);
      const pts       = (currPts && prevPts) ? Math.max(0, currPts - prevPts) : 0;

      const prevVol   = +($('prevVol').value||0);
      const currVol   = +($('currVol').value||0);
      const volDelta  = (currVol && prevVol) ? Math.max(0, currVol - prevVol) : 0;

      const volFromPts = (pts>0 && xpPerDollar>0) ? (pts/xpPerDollar) : 0;
      const volume = volManual || volDelta || volFromPts;

      // 실측 수수료/셀프레퍼럴 → 평균 수수료율 & Taker 비중 역산
      let feePaid = +($('feePaid').value||0);
      const refRev = +($('refRev').value||0);
      const refShare = (+($('refShare').value||60))/100;

      if(!feePaid && refRev && refShare>0) feePaid = refRev / refShare;

      let avgFeeRate, takerRatio=null, estTakerFills=null;
      if(feePaid && volume>0){
        avgFeeRate = feePaid/volume;
        const denom = takerFee - makerFee;
        takerRatio = denom>0 ? Math.min(1, Math.max(0, (avgFeeRate - makerFee)/denom)) : 0;
        const avgFill = +($('avgFill').value||0);
        if(avgFill>0) estTakerFills = Math.round((volume * takerRatio)/avgFill);
      } else {
        avgFeeRate = makerFee; // 기본: 지정가만 가정
      }

      const totalFee = volume * avgFeeRate;
      const selfRef  = totalFee * refShare;     // 셀프레퍼럴 수익
      const xp       = volume * (xpPerDollar||0);
      const volPerXP = xp>0 ? (volume/xp) : 0;
      const netFee   = totalFee - selfRef;      // 셀프레퍼럴 차감 후
      const costPerXP = xp>0 ? (netFee/xp) : 0; // 실질 비용/XP

      const d2 = n=> Number(n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
      const d4 = n=> Number(n).toLocaleString(undefined,{minimumFractionDigits:4, maximumFractionDigits:4});

      let html = `<div class="bg-emerald-900/20 border border-emerald-800 rounded-xl p-3">
        <div class="font-semibold">✅ 최종 정리</div>
        <ul class="list-disc ml-5 mt-2 num space-y-1">
          <li>이전 거래량: ${d2(prevVol)} $</li>
          <li>현재 거래량: ${d2(currVol)} $</li>
          <li>거래량(계산 기준): ${d2(volume)} $</li>
          <li>획득 XP: ${d2(xp)} XP (XP 효율: ${d4(xpPerDollar)} XP/$)</li>
          <li>1 XP당 거래량: ${volPerXP? d4(volPerXP): '—'} $/XP</li>
          <li>총 수수료(추정): ${d2(totalFee)} $</li>
          <li>셀프레퍼럴( ${d2(refShare*100)}% ): ${d2(selfRef)} $</li>
          <li>실제 낸 수수료(= 총 수수료 − 셀프레퍼럴): ${d2(netFee)} $</li>
          <li>1 XP당 <b>실질 비용</b>(수수료만): ${costPerXP? d4(costPerXP): '—'} $/XP</li>
        </ul>
      </div>`;

      html += `<div class="bg-slate-950/60 rounded-xl p-3 border border-slate-800 num">
        <div class="text-[11px] text-slate-400">수수료율 추정</div>
        <div>평균 수수료율: ${d4(avgFeeRate*100)} %</div>
        <div class="text-[11px] text-slate-400 mt-1">기본은 Maker ${d4(makerFee*100)}% 가정. 실측 수수료/셀프레퍼럴을 입력하면 Taker 비중을 역산합니다.</div>`;
      if(takerRatio!==null){
        html += `<div class="mt-1">추정 Taker 비중: ${d4(takerRatio*100)} %${estTakerFills!==null? ` · 추정 Taker 체결 ~${estTakerFills}건`:''}</div>`;
      }
      html += `</div>`;

      $('out').innerHTML = html;
    }

    function saveInputs(){
      const keys = ['marketKind','xpBoost','xpPerDollar','makerFee','takerFee','refShare','volume','prevPts','currPts','prevVol','currVol','feePaid','refRev','avgFill'];
      const obj = {}; keys.forEach(k=> obj[k] = $(k).value);
      localStorage.setItem('xp-fee-calc', JSON.stringify(obj));
      const btn = $('save'); btn.textContent = '저장됨'; setTimeout(()=>btn.textContent='입력값 저장', 1200);
    }

    function loadInputs(){
      setXp();
      const raw = localStorage.getItem('xp-fee-calc');
      if(!raw) return;
      try{ const obj = JSON.parse(raw); Object.keys(obj).forEach(k=> { if($(k)) $(k).value = obj[k]; }); }catch{}
    }

    // 이벤트
    $('xpBoost').addEventListener('change', setXp);
    $('marketKind').addEventListener('change', setXp);
    $('calc').addEventListener('click', compute);
    $('calcFloating').addEventListener('click', compute);
    ['volume','prevPts','currPts','prevVol','currVol','feePaid','refRev','avgFill'].forEach(id=>{
      const el=$(id); if(!el) return; el.addEventListener('keydown',e=>{ if(e.key==='Enter') compute(); });
    });
    $('save').addEventListener('click', saveInputs);
    $('reset').addEventListener('click', ()=>{ localStorage.removeItem('xp-fee-calc'); location.reload(); });

    // init
    loadInputs(); setXp(); compute();
  </script>
</body>
</html>
